# Full Route Implementation

## Overview

This document outlines the implementation of a full route feature in the GPX uploader component. The full route combines all individual routes into a single route for visualization and analysis.

## Requirements

1. Add a dropdown menu for route type selection with the following options:
   - Tourism
   - Event
   - Bikepacking
   - Single

2. Create a full route that combines all routes when the type is "Bikepacking"

3. Only show the full route if the selected type is "Bikepacking"

4. The full route should have:
   - Stats (distance, unpaved percentage, elevation gain/loss)
   - Elevation profile
   - Its own description to update

5. The full route should:
   - Be non-draggable (fixed at the top)
   - Be non-deletable
   - Not have an editable name
   - Not have a color picker button

6. Add a "Stages" title above the individual routes list

## Implementation Details

### 1. Route Type Selection

- Add a state variable `routeType` to store the selected route type
- Add a dropdown menu (MUI Select component) above the route list
- Default value will be "Single"
- Auto-save the route type to Firebase when it changes

### 2. Full Route Generation

When the route type is "Bikepacking", a full route will be generated by:

- Combining GeoJSON data from all routes
- Calculating aggregate statistics (total distance, elevation gain/loss, unpaved percentage)
- Creating a unique identifier for the full route
- Ensuring it can be selected like other routes
- Adding a priority property to ensure it renders on top of other routes
- Auto-saving the full route description to Firebase

### 3. Conditional Rendering

- The full route will only be displayed when the route type is "Bikepacking"
- For other types (Tourism, Event, Single), only the individual routes will be shown
- A "Stages" title will be displayed above the individual routes list

### 4. Technical Approach

1. Add state for route type in UploaderUI.jsx
2. Add the dropdown menu above the route list
3. Create a function to generate the full route
4. Conditionally render the full route based on the selected type
5. Ensure the full route can be selected and displays properly
6. Make the full route non-draggable and non-deletable
7. Remove name editing functionality for the full route
8. Remove color picker button for the full route
9. Add a "Stages" title above the individual routes list
10. Implement auto-save functionality for the route type and master route description

## Code Structure

The implementation will primarily modify the `UploaderUI.jsx` component:

1. Add state:
   ```jsx
   const [routeType, setRouteType] = useState('Single');
   ```

2. Add dropdown:
   ```jsx
   <FormControl fullWidth sx={{ mb: 2 }}>
     <InputLabel>Route Type</InputLabel>
     <Select
       value={routeType}
       onChange={(e) => setRouteType(e.target.value)}
     >
       <MenuItem value="Tourism">Tourism</MenuItem>
       <MenuItem value="Event">Event</MenuItem>
       <MenuItem value="Bikepacking">Bikepacking</MenuItem>
       <MenuItem value="Single">Single</MenuItem>
     </Select>
   </FormControl>
   ```

3. Generate full route:
   ```jsx
   const masterRoute = useMemo(() => {
     if (routeType !== 'Bikepacking' || !localRoutes || localRoutes.length === 0) return null;
     
     // Create a combined route object
     return {
       routeId: "master-route",
       id: "master-route",
       name: "Full Route",
       color: "#4a9eff", // Blue color for full route
       priority: 100, // High priority to ensure it renders on top
       // Combined data...
     };
   }, [routeType, localRoutes]);
   ```

4. Render full route (non-draggable, non-deletable, no name editing, no color picker):
   ```jsx
   {routeType === 'Bikepacking' && masterRoute && (
     <Box sx={{ mb: 2 }}>
       <Typography 
         variant="subtitle2" 
         sx={{ 
           borderBottom: '1px solid rgba(255, 255, 255, 0.1)', 
           paddingBottom: '8px',
           marginBottom: '8px',
           fontWeight: 'bold',
           color: '#4a9eff'
         }}
       >
         Full Route
       </Typography>
       <Box
         onClick={() => setCurrentRoute(masterRoute)}
         sx={{
           backgroundColor: currentRoute?.routeId === masterRoute.routeId ? 'rgba(74, 158, 255, 0.15)' : 'rgba(35, 35, 35, 0.9)',
           borderRadius: '4px',
           mb: 1,
           padding: '6px 36px 6px 8px',
           // Other styling...
         }}
       >
         <Box sx={{ width: '100%', display: 'flex', flexDirection: 'column', gap: 0.25, pt: 0.5 }}>
           {/* Distance row (no color button) */}
           <Box sx={{ display: 'flex', alignItems: 'center', height: '20px' }}>
             <Typography variant="body2" sx={{ fontSize: '0.75rem', display: 'flex', alignItems: 'center', gap: 0.5 }}>
               <i className="fa-solid fa-route" style={{ color: '#2196f3', fontSize: '0.75rem' }} /> {(getRouteDistance(masterRoute) / 1000).toFixed(1)}km
             </Typography>
           </Box>
           {/* Other stats... */}
         </Box>
       </Box>
     </Box>
   )}
   ```

5. Add "Stages" title above individual routes:
   ```jsx
   {localRoutes.length > 0 && (
     <>
       <Typography 
         variant="subtitle2" 
         sx={{ 
           borderBottom: '1px solid rgba(255, 255, 255, 0.1)', 
           paddingBottom: '8px',
           marginBottom: '8px',
           fontWeight: 'bold',
           color: '#4a9eff',
           width: '100%'
         }}
       >
         Stages
       </Typography>
       <DndContext>
         {/* Routes list... */}
       </DndContext>
     </>
   )}
   ```

## Auto-Save Implementation

We've implemented auto-save functionality for the master route to ensure that changes to the route type and master route description are automatically saved to Firebase. This ensures that users' work is preserved even if they refresh the page or come back to the application later.

### Data Structure in Firestore

```
gpx_auto_saves/{autoSaveId}:
  - routeType: string (One of: "Bikepacking", "Tourism", "Event", "Single")
  - ... (other fields as before)

gpx_auto_saves/{autoSaveId}/data/masterRoute:
  - data: object (Master route data)
    {
      description: string (Description of the master route),
      statistics: object (Combined statistics for all routes)
    }
```

### Implementation Details

1. **Route Type Auto-Save:**
   - Added a new function `updateRouteInFirebase` in `firebaseGpxAutoSaveService.js` that handles updating the route type in Firebase
   - Modified the route type selection dropdown to call this function when the route type changes
   - The function updates the main document with the new route type and sets the `updatedAt` timestamp

2. **Master Route Description Auto-Save:**
   - Added a new function `updateMasterRouteInFirebase` in `firebaseGpxAutoSaveService.js` that handles saving the master route description to Firebase
   - Modified the description editor to call this function when the description changes
   - The function creates or updates the masterRoute document with the description and statistics

3. **Conditional Document Creation:**
   - When the route type is changed to "Bikepacking", a masterRoute document is created if it doesn't exist
   - When the route type is changed from "Bikepacking" to another type, the masterRoute document is removed

### Trigger Points

Auto-save for the master route is triggered when:
- The route type is changed to "Bikepacking"
- The master route description is edited
- Individual routes are added, removed, or reordered (causing the master route to be regenerated)

## Testing

The implementation should be tested with:

1. Different route types to verify conditional rendering
2. Multiple routes to ensure proper combination
3. Selecting the full route to verify it works like other routes
4. Checking that statistics are correctly aggregated
5. Verifying that the full route cannot be dragged or deleted
6. Confirming that the "Stages" title appears above the individual routes
7. Changing the route type and verifying that it's saved to Firebase
8. Editing the master route description and verifying that it's saved to Firebase
9. Refreshing the page and verifying that the route type and master route description are restored
