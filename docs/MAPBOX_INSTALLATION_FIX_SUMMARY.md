# Mapbox Installation Troubleshooting Summary (Mobile App)

This document details the steps taken to resolve persistent issues encountered while installing and building the Mapbox dependencies for the Lutruwita Mobile iOS app using Expo.

## Initial Problem

The primary issue manifested as errors during the `pod install` phase, either run manually or as part of `npx expo prebuild`. The core errors encountered were:

1.  **CocoaPods Compatibility Error:**
    ```
    [!] CocoaPods could not find compatible versions for pod "MapboxMaps":
      In Podfile:
        rnmapbox-maps (from `../node_modules/@rnmapbox/maps`) was resolved to [VERSION], which depends on
          MapboxMaps (= [NATIVE_VERSION])

    None of your spec sources contain a spec satisfying the dependency: `MapboxMaps (= [NATIVE_VERSION])`.

    You have either:
     * mistyped the name or version.
     * not added the source repo that hosts the Podspec to your Podfile.
    ```
    This indicated that CocoaPods couldn't find the specified native Mapbox SDK version (`[NATIVE_VERSION]`) in the configured repositories.

2.  **Swift Compilation Error ("no such module"):**
    ```
    ‚ùå (node_modules/@rnmapbox/maps/ios/[...]/MGLModule.swift:3:8)
    no such module 'MapboxMobileEvents'
    ```
    This occurred when attempting to use Mapbox SDK v11.x, indicating the `@rnmapbox/maps` library code was trying to import a module (`MapboxMobileEvents`) that is handled differently or no longer exists as a separate import in SDK v11.

3.  **Swift Compilation Errors (Type Mismatches/Missing Members):**
    Numerous errors like `cannot find type 'ViewportStatus' in scope`, `value of type 'MapView' has no member 'viewport'`, etc. These occurred when there was a version mismatch between the `@rnmapbox/maps` library code and the installed native Mapbox SDK version (e.g., using v10 library code with v11 SDK).

## Troubleshooting Steps & Findings

We systematically tried various combinations of versions and configurations:

1.  **Initial State:** The project seemed to be initially configured for `@rnmapbox/maps` v10.0.15 and native SDK v10.0.15. This failed with the CocoaPods compatibility error.
2.  **Checking Sources:** We identified that the `Podfile` (often generated by `expo prebuild`) might be missing the necessary Mapbox-specific podspec repository source URL. Mapbox hosts its pods separately from the main CocoaPods trunk.
3.  **Attempting Different v10 Versions:**
    *   Tried `@rnmapbox/maps` `10.0.11` / native SDK `10.0.11`. Failed (podspec not found).
    *   Tried `@rnmapbox/maps` `10.1.38` / native SDK `10.13.2`. Failed (podspec not found).
    *   Tried `@rnmapbox/maps` `10.1.38` / native SDK `10.1.38`. Failed (podspec not found).
4.  **Manually Adding Pod Sources:** We attempted to manually add potential Mapbox source URLs to the `Podfile` (`https://github.com/mapbox/mapbox-gl-native-ios.git`, `https://github.com/mapbox/mapbox-sdk-ios-specs.git`). The latter URL seemed correct based on external info but failed to be added via `pod repo add`, indicating it might be outdated or incorrect. The former didn't resolve the dependency finding issue.
5.  **Checking `package-lock.json`:** Confirmed that the lock file could sometimes lock to an older version (`10.0.15`) even if `package.json` requested a newer one, necessitating deleting the lock file and `node_modules` for a clean install.
6.  **Attempting v11:** Based on user input and the nature of the Swift errors (missing types like `ViewportStatus`), we deduced the codebase likely expected SDK v11.
    *   We tried setting `RNMapboxMapsVersion` to `11.11.0` in `app.json` and `@rnmapbox/maps` to `10.1.38` in `package.json` (since no v11 of the RN library exists on npm).
    *   This led to the `no such module 'MapboxMobileEvents'` error during the build phase.
7.  **Investigating `MapboxMobileEvents`:** We found that the `@rnmapbox/maps` library code (in `RNMBXModule.swift`) conditionally imports `MapboxMobileEvents`. This import fails with SDK v11 because Mapbox changed how telemetry/events are handled (it's now integrated, not a separate module).
8.  **Patching the Library:** The solution required patching the `@rnmapbox/maps` library code to prevent the problematic import when using SDK v11.

## Final Solution

The configuration that ultimately allowed the project to build successfully involved:

1.  **Versions:**
    *   `package.json`: `"@rnmapbox/maps": "10.1.38"` (Latest available version on npm).
    *   `app.json`: `"RNMapboxMapsVersion": "11.11.0"` (Target native SDK version).
    *   `app.json`: `"RNMapboxMapsInstallMethod": "spm"` (Using Swift Package Manager, recommended for SDK v11).
2.  **Patching:**
    *   Commented out the `import MapboxMobileEvents` line within the `#if canImport(MapboxMobileEvents)` block in `mobile/lutruwita-mobile/node_modules/@rnmapbox/maps/ios/RNMBX/RNMBXModule.swift`.
    *   Saved this change using `npx patch-package @rnmapbox/maps`. This creates a `patches/@rnmapbox+maps+10.1.38.patch` file to ensure the change persists across installs.
3.  **Installation Process:**
    *   Ensure `node_modules` and `package-lock.json` are removed for a clean state.
    *   **Verify `app.json`:** Double-check that the `RNMapboxMapsVersion` within the `@rnmapbox/maps` plugin configuration in `app.json` is set to the correct target native SDK version (e.g., `"11.11.0"`). An incorrect version here was a source of recent issues.
    *   Ensure `node_modules` and `package-lock.json` are removed for a clean state (`rm -rf node_modules package-lock.json`).
    *   Run `npm install` (this installs `@rnmapbox/maps@10.1.38` and applies the patch).
    *   Run `npx expo prebuild --clean`. The `--clean` flag is crucial as it removes the existing `ios` directory, ensuring a completely fresh native project generation based on the current configuration and preventing conflicts from previous builds.
    *   Run `npx expo run:ios` (or build via Xcode).

## Why This Worked

The core issue was an incompatibility between the latest *available* React Native library (`@rnmapbox/maps` v10.1.38) and the desired *native* Mapbox SDK (v11.11.0). The library code hadn't been updated to reflect changes in the v11 SDK regarding `MapboxMobileEvents`. By patching the library code to remove the problematic import, we allowed the v10 library to build successfully against the v11 native SDK installed via SPM.

## Future Considerations

*   This patch might break if `@rnmapbox/maps` is updated, as the patch file might no longer apply cleanly.
*   The ideal solution is for the `@rnmapbox/maps` library maintainers to release a new version (e.g., v11.x) that officially supports Mapbox SDK v11 and handles the `MapboxMobileEvents` changes correctly. Keep an eye on their repository for updates.
